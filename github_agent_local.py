import requests
import os
from datetime import datetime
from collections import Counter, defaultdict
import json

class GitHubAnalyzer:
    """
    Analizador de repositorios GitHub que NO requiere API de Anthropic
    Todo el an√°lisis se hace localmente con l√≥gica Python
    """
    
    def __init__(self, github_token=None):
        self.github_token = github_token or os.environ.get("GITHUB_TOKEN")
        self.headers = {}
        if self.github_token:
            self.headers["Authorization"] = f"token {self.github_token}"
        
        self.cache = {}
    
    def obtener_datos_repo(self, owner, repo):
        """Obtiene todos los datos necesarios del repositorio"""
        print(f"üì• Descargando datos de {owner}/{repo}...")
        
        base_url = f"https://api.github.com/repos/{owner}/{repo}"
        
        try:
            # Informaci√≥n b√°sica
            print("  ‚è≥ Info del repositorio...")
            repo_info = self._get_json(base_url)
            
            # Contribuidores
            print("  ‚è≥ Contribuidores...")
            contributors = self._get_json(f"{base_url}/contributors?per_page=100")
            
            # Commits recientes
            print("  ‚è≥ Commits recientes...")
            commits = self._get_json(f"{base_url}/commits?per_page=100")
            
            # √Årbol de archivos
            print("  ‚è≥ Estructura de archivos...")
            default_branch = repo_info.get('default_branch', 'main')
            tree = self._get_json(f"{base_url}/git/trees/{default_branch}?recursive=1")
            
            # Issues y PRs
            print("  ‚è≥ Issues y Pull Requests...")
            issues = self._get_json(f"{base_url}/issues?state=all&per_page=100")
            
            # Lenguajes
            print("  ‚è≥ Lenguajes...")
            languages = self._get_json(f"{base_url}/languages")
            
            print("‚úÖ Datos descargados correctamente\n")
            
            return {
                'repo': repo_info,
                'contributors': contributors,
                'commits': commits,
                'tree': tree.get('tree', []) if isinstance(tree, dict) else [],
                'issues': issues,
                'languages': languages
            }
            
        except Exception as e:
            print(f"‚ùå Error obteniendo datos: {e}")
            return None
    
    def _get_json(self, url):
        """Helper para hacer requests a GitHub API"""
        try:
            response = requests.get(url, headers=self.headers, timeout=10)
            response.raise_for_status()
            return response.json()
        except Exception as e:
            print(f"‚ö†Ô∏è  Error en {url}: {e}")
            return []
    
    def quien_mas_contribuye(self, data):
        """Analiza qui√©n es el mayor contribuidor"""
        print("üèÜ PRINCIPAL CONTRIBUIDOR")
        print("="*60)
        
        contributors = data.get('contributors', [])
        if not contributors:
            print("‚ùå No se encontraron contribuidores")
            return
        
        # Top 10 contribuidores
        print(f"\nüìä Top 10 Contribuidores (de {len(contributors)} totales):\n")
        for i, contrib in enumerate(contributors[:10], 1):
            login = contrib.get('login', 'Unknown')
            contributions = contrib.get('contributions', 0)
            print(f"{i:2}. {login:20} - {contributions:5} contribuciones")
        
        # Estad√≠sticas del top 1
        top = contributors[0]
        total_contributions = sum(c.get('contributions', 0) for c in contributors)
        percentage = (top.get('contributions', 0) / total_contributions * 100) if total_contributions > 0 else 0
        
        print(f"\nü•á Ganador: {top.get('login')}")
        print(f"   ‚Ä¢ Contribuciones: {top.get('contributions')}")
        print(f"   ‚Ä¢ Porcentaje del total: {percentage:.1f}%")
        print(f"   ‚Ä¢ Perfil: https://github.com/{top.get('login')}")
        print("="*60 + "\n")
    
    def velocidad_desarrollo(self, data):
        """Analiza la velocidad de desarrollo"""
        print("‚ö° VELOCIDAD DE DESARROLLO")
        print("="*60)
        
        commits = data.get('commits', [])
        repo = data.get('repo', {})
        
        if not commits:
            print("‚ùå No se encontraron commits")
            return
        
        # Analizar fechas
        dates = []
        authors = []
        for commit in commits:
            commit_data = commit.get('commit', {})
            author_info = commit_data.get('author', {})
            date_str = author_info.get('date')
            
            if date_str:
                dates.append(datetime.fromisoformat(date_str.replace('Z', '+00:00')))
                authors.append(author_info.get('name', 'Unknown'))
        
        if not dates:
            print("‚ùå No se pudieron procesar las fechas")
            return
        
        # Estad√≠sticas temporales
        dates.sort()
        primer_commit = dates[0]
        ultimo_commit = dates[-1]
        dias_transcurridos = (ultimo_commit - primer_commit).days
        
        print(f"\nüìÖ Periodo analizado:")
        print(f"   ‚Ä¢ Primer commit: {primer_commit.strftime('%Y-%m-%d %H:%M')}")
        print(f"   ‚Ä¢ √öltimo commit: {ultimo_commit.strftime('%Y-%m-%d %H:%M')}")
        print(f"   ‚Ä¢ D√≠as transcurridos: {dias_transcurridos}")
        
        print(f"\nüìà M√©tricas:")
        print(f"   ‚Ä¢ Total de commits (√∫ltimos 100): {len(commits)}")
        print(f"   ‚Ä¢ Commits por d√≠a: {len(commits)/dias_transcurridos:.2f}" if dias_transcurridos > 0 else "   ‚Ä¢ N/A")
        print(f"   ‚Ä¢ Commits por semana: {len(commits)/dias_transcurridos*7:.1f}" if dias_transcurridos > 0 else "   ‚Ä¢ N/A")
        
        # Autores √∫nicos
        unique_authors = len(set(authors))
        print(f"   ‚Ä¢ Autores activos: {unique_authors}")
        
        # Repo info
        print(f"\nüìä Estado general del repositorio:")
        print(f"   ‚Ä¢ Stars: {repo.get('stargazers_count', 0)}")
        print(f"   ‚Ä¢ Forks: {repo.get('forks_count', 0)}")
        print(f"   ‚Ä¢ Watchers: {repo.get('watchers_count', 0)}")
        print(f"   ‚Ä¢ Issues abiertas: {repo.get('open_issues_count', 0)}")
        
        print("="*60 + "\n")
    
    def area_mas_compleja(self, data):
        """Identifica el √°rea m√°s compleja del c√≥digo"""
        print("üß© √ÅREA M√ÅS COMPLEJA DEL C√ìDIGO")
        print("="*60)
        
        tree = data.get('tree', [])
        if not tree:
            print("‚ùå No se pudo obtener la estructura de archivos")
            return
        
        # Analizar por directorio
        dir_stats = defaultdict(lambda: {'files': 0, 'total_size': 0, 'extensions': Counter()})
        
        for item in tree:
            if item.get('type') == 'blob':  # Es un archivo
                path = item.get('path', '')
                size = item.get('size', 0)
                
                # Obtener directorio
                parts = path.split('/')
                if len(parts) > 1:
                    directory = parts[0]
                else:
                    directory = '(ra√≠z)'
                
                # Obtener extensi√≥n
                extension = path.split('.')[-1] if '.' in path else 'sin_ext'
                
                dir_stats[directory]['files'] += 1
                dir_stats[directory]['total_size'] += size
                dir_stats[directory]['extensions'][extension] += 1
        
        # Ordenar por n√∫mero de archivos (indicador de complejidad)
        sorted_dirs = sorted(dir_stats.items(), key=lambda x: x[1]['files'], reverse=True)
        
        print(f"\nüìÅ Top 10 Directorios por n√∫mero de archivos:\n")
        for i, (dirname, stats) in enumerate(sorted_dirs[:10], 1):
            size_mb = stats['total_size'] / (1024 * 1024)
            print(f"{i:2}. {dirname:30} - {stats['files']:4} archivos, {size_mb:.2f} MB")
        
        # El m√°s complejo
        if sorted_dirs:
            most_complex = sorted_dirs[0]
            dirname, stats = most_complex
            
            print(f"\nüèÜ √Årea m√°s compleja: {dirname}")
            print(f"   ‚Ä¢ Archivos: {stats['files']}")
            print(f"   ‚Ä¢ Tama√±o total: {stats['total_size'] / (1024 * 1024):.2f} MB")
            print(f"   ‚Ä¢ Tipos de archivo:")
            for ext, count in stats['extensions'].most_common(5):
                print(f"     - .{ext}: {count} archivos")
        
        print("="*60 + "\n")
    
    def revisar_documentacion(self, data):
        """Revisa la documentaci√≥n del proyecto"""
        print("üìö ESTADO DE LA DOCUMENTACI√ìN")
        print("="*60)
        
        tree = data.get('tree', [])
        repo = data.get('repo', {})
        
        # Buscar archivos de documentaci√≥n
        doc_patterns = ['readme', 'contributing', 'license', 'changelog', 'docs/', 
                       'documentation', 'guide', 'tutorial', 'api', '.md']
        
        doc_files = []
        for item in tree:
            if item.get('type') == 'blob':
                path = item.get('path', '').lower()
                if any(pattern in path for pattern in doc_patterns):
                    doc_files.append({
                        'path': item.get('path'),
                        'size': item.get('size', 0)
                    })
        
        print(f"\nüìÑ Archivos de documentaci√≥n encontrados: {len(doc_files)}\n")
        
        # Categorizar
        categories = {
            'README': [],
            'Gu√≠as de contribuci√≥n': [],
            'Licencias': [],
            'Changelog': [],
            'Documentaci√≥n API/T√©cnica': [],
            'Otros': []
        }
        
        for doc in doc_files:
            path = doc['path'].lower()
            if 'readme' in path:
                categories['README'].append(doc)
            elif 'contributing' in path or 'contribute' in path:
                categories['Gu√≠as de contribuci√≥n'].append(doc)
            elif 'license' in path:
                categories['Licencias'].append(doc)
            elif 'changelog' in path or 'history' in path:
                categories['Changelog'].append(doc)
            elif 'docs/' in path or 'api' in path or 'guide' in path:
                categories['Documentaci√≥n API/T√©cnica'].append(doc)
            else:
                categories['Otros'].append(doc)
        
        for category, files in categories.items():
            if files:
                print(f"üìå {category}: {len(files)} archivo(s)")
                for f in files[:3]:  # Mostrar m√°ximo 3 por categor√≠a
                    size_kb = f['size'] / 1024
                    print(f"   ‚Ä¢ {f['path']} ({size_kb:.1f} KB)")
                if len(files) > 3:
                    print(f"   ... y {len(files)-3} m√°s")
        
        # Evaluaci√≥n
        print(f"\nüìä Evaluaci√≥n:")
        score = 0
        if categories['README']:
            print("   ‚úÖ Tiene README")
            score += 2
        else:
            print("   ‚ùå Falta README")
        
        if categories['Gu√≠as de contribuci√≥n']:
            print("   ‚úÖ Tiene gu√≠a de contribuci√≥n")
            score += 1
        
        if categories['Licencias']:
            print("   ‚úÖ Tiene licencia")
            score += 1
        
        if len(categories['Documentaci√≥n API/T√©cnica']) > 3:
            print("   ‚úÖ Buena documentaci√≥n t√©cnica")
            score += 2
        elif categories['Documentaci√≥n API/T√©cnica']:
            print("   ‚ö†Ô∏è  Documentaci√≥n t√©cnica limitada")
            score += 1
        
        print(f"\nüéØ Puntuaci√≥n de documentaci√≥n: {score}/6")
        
        if repo.get('description'):
            print(f"\nüí¨ Descripci√≥n del repo: {repo.get('description')}")
        
        print("="*60 + "\n")
    
    def resumen_ejecutivo(self, data):
        """Genera un resumen ejecutivo completo"""
        print("üìã RESUMEN EJECUTIVO")
        print("="*60)
        
        repo = data.get('repo', {})
        contributors = data.get('contributors', [])
        languages = data.get('languages', {})
        commits = data.get('commits', [])
        
        print(f"\nüè∑Ô∏è  Nombre: {repo.get('full_name', 'N/A')}")
        if repo.get('description'):
            print(f"üìù Descripci√≥n: {repo.get('description')}")
        
        print(f"\nüìä M√©tricas clave:")
        print(f"   ‚Ä¢ ‚≠ê Stars: {repo.get('stargazers_count', 0):,}")
        print(f"   ‚Ä¢ üî± Forks: {repo.get('forks_count', 0):,}")
        print(f"   ‚Ä¢ üëÄ Watchers: {repo.get('watchers_count', 0):,}")
        print(f"   ‚Ä¢ üêõ Issues abiertas: {repo.get('open_issues_count', 0):,}")
        print(f"   ‚Ä¢ üì¶ Tama√±o: {repo.get('size', 0) / 1024:.1f} MB")
        
        print(f"\nüë• Comunidad:")
        print(f"   ‚Ä¢ Contribuidores: {len(contributors)}")
        if contributors:
            top3 = ', '.join([c.get('login', 'N/A') for c in contributors[:3]])
            print(f"   ‚Ä¢ Top 3: {top3}")
        
        print(f"\nüíª Tecnolog√≠as:")
        if languages:
            total = sum(languages.values())
            for lang, bytes_count in sorted(languages.items(), key=lambda x: x[1], reverse=True)[:5]:
                percentage = (bytes_count / total * 100) if total > 0 else 0
                print(f"   ‚Ä¢ {lang}: {percentage:.1f}%")
        
        print(f"\nüìÖ Actividad:")
        print(f"   ‚Ä¢ Creado: {repo.get('created_at', 'N/A')[:10]}")
        print(f"   ‚Ä¢ √öltima actualizaci√≥n: {repo.get('updated_at', 'N/A')[:10]}")
        if commits:
            print(f"   ‚Ä¢ Commits recientes analizados: {len(commits)}")
        
        print(f"\nüîó Enlaces:")
        print(f"   ‚Ä¢ Repo: {repo.get('html_url', 'N/A')}")
        if repo.get('homepage'):
            print(f"   ‚Ä¢ Web: {repo.get('homepage')}")
        
        print("="*60 + "\n")
    
    def analizar_completo(self, owner, repo):
        """Realiza un an√°lisis completo del repositorio"""
        print("\n" + "="*60)
        print(f"üîç AN√ÅLISIS COMPLETO: {owner}/{repo}")
        print("="*60 + "\n")
        
        data = self.obtener_datos_repo(owner, repo)
        if not data:
            print("‚ùå No se pudo obtener los datos del repositorio")
            return
        
        # Realizar todos los an√°lisis
        self.resumen_ejecutivo(data)
        self.quien_mas_contribuye(data)
        self.velocidad_desarrollo(data)
        self.area_mas_compleja(data)
        self.revisar_documentacion(data)
        
        print("‚úÖ An√°lisis completado")


def menu_interactivo():
    """Men√∫ interactivo"""
    print("="*60)
    print("ü§ñ ANALIZADOR DE REPOSITORIOS GITHUB (100% GRATUITO)")
    print("="*60)
    print("\n‚ú® No requiere API de Anthropic - Todo local")
    
    analyzer = GitHubAnalyzer()
    
    print("\nüìÅ Ingresa el repositorio a analizar:")
    owner = input("Owner (ej: mozilla-ai): ").strip() or "mozilla-ai"
    repo = input("Repo (ej: lumigator): ").strip() or "lumigator"
    
    if not owner or not repo:
        print("‚ùå Debes ingresar owner y repo")
        return
    
    # Obtener datos una sola vez
    data = analyzer.obtener_datos_repo(owner, repo)
    if not data:
        return
    
    while True:
        print("\n" + "="*60)
        print("üìã OPCIONES DE AN√ÅLISIS:")
        print("="*60)
        print("1. üèÜ ¬øQui√©n m√°s ha contribuido?")
        print("2. ‚ö° Velocidad de desarrollo")
        print("3. üß© √Årea m√°s compleja del c√≥digo")
        print("4. üìö Revisar documentaci√≥n")
        print("5. üìã Resumen ejecutivo completo")
        print("6. üîÑ Cambiar de repositorio")
        print("0. üëã Salir")
        
        opcion = input("\nElige una opci√≥n: ").strip()
        
        if opcion == '0':
            print("\nüëã ¬°Hasta luego!")
            break
        elif opcion == '1':
            analyzer.quien_mas_contribuye(data)
        elif opcion == '2':
            analyzer.velocidad_desarrollo(data)
        elif opcion == '3':
            analyzer.area_mas_compleja(data)
        elif opcion == '4':
            analyzer.revisar_documentacion(data)
        elif opcion == '5':
            analyzer.resumen_ejecutivo(data)
        elif opcion == '6':
            menu_interactivo()
            return
        else:
            print("‚ùå Opci√≥n inv√°lida")
        
        input("\n‚èé Presiona Enter para continuar...")


if __name__ == "__main__":
    """
    SETUP ULTRA-R√ÅPIDO (100% GRATUITO):
    
    1. Instala una sola dependencia:
       pip install requests
    
    2. Ejecuta:
       python github_agent.py
    
    ¬°Eso es todo! No necesitas ninguna API key de pago.
    
    OPCIONAL - M√°s l√≠mite de requests:
       export GITHUB_TOKEN='tu-token-de-github'
       (Obt√©n uno gratis en: https://github.com/settings/tokens)
    """
    
    try:
        menu_interactivo()
    except KeyboardInterrupt:
        print("\n\nüëã Interrumpido por el usuario")
    except Exception as e:
        print(f"\n‚ùå Error: {e}")